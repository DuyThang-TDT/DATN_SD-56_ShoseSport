
@model FurryFriends.Web.ViewModels.DonHangKhachHangViewModel

@{
    ViewData["Title"] = $"Chi ti·∫øt ƒë∆°n h√†ng #{Model.HoaDonId.ToString().Substring(0, 8).ToUpper()} - FuryFriend";
}

@section Styles {
    <style>
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
            padding: 5rem 0;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        /* Breadcrumb */
        .breadcrumb-modern {
            background: white;
            border-radius: 15px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .breadcrumb-modern .breadcrumb-item a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumb-modern .breadcrumb-item.active {
            color: #64748b;
        }

        /* Order Type Badge */
        .order-type-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 1rem;
        }

        .order-type-offline {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .order-type-online {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        /* Status Badge */
        .status-badge {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-pending {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .status-approved {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .status-shipping {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .status-delivered {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .status-cancelled {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Main Container */
        .order-details-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }

        /* Order Header */
        .order-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 3rem;
            text-align: center;
            position: relative;
        }

        .order-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .order-date {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 3rem;
        }

        .info-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .info-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .info-card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .info-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #64748b;
            font-weight: 500;
        }

        .info-value {
            color: #1e293b;
            font-weight: 600;
        }

        /* Products Section */
        .products-section {
            padding: 3rem;
            background: #f8fafc;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .section-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }

        .products-grid {
            display: grid;
            gap: 1.5rem;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .product-row {
            display: grid;
            grid-template-columns: 80px 1fr auto auto;
            gap: 1rem;
            align-items: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        
        .product-image-placeholder {
            width: 80px;
            height: 80px;
            background-color: #f1f5f9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
        }

        .product-info {
            min-width: 0;
        }

        .product-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .product-variants {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .variant-badge {
            background: #f1f5f9;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .product-quantity {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            text-align: center;
        }

        .product-total {
            font-size: 1.125rem;
            font-weight: 700;
            color: #10b981;
            text-align: right;
        }
        
        /* ‚úÖ CSS cho voucher v√† gi·∫£m gi√° */
        .total-item.text-success {
            color: #059669;
        }
        
        .total-item.text-muted {
            color: #6b7280;
        }
        
        .total-item.small {
            font-size: 0.875rem;
        }

        /* Order Summary */
        .order-summary {
            background: white;
            padding: 3rem;
            border-top: 1px solid #e5e7eb;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 3rem;
            align-items: start;
        }

        .summary-left {
            display: grid;
            gap: 1.5rem;
        }

        .summary-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .summary-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-right {
            min-width: 300px;
        }

        .total-card {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
        }

        .total-breakdown {
            margin-bottom: 1.5rem;
        }

        .total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .total-item.final {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 1rem;
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            opacity: 1;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-modern {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* ‚úÖ N√∫t g·ª≠i email */
        .btn-email {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-email:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-email:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(156, 163, 175, 0.3);
        }

        /* ‚úÖ Loading spinner cho email */
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ‚úÖ Hi·ªáu ·ª©ng ripple cho button */
        .btn-email::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-email:active::before {
            width: 300px;
            height: 300px;
        }

        /* ‚úÖ Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            min-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-success .toast-icon {
            color: #10b981;
        }

        .toast-error .toast-icon {
            color: #ef4444;
        }

        .toast-message {
            color: #374151;
            font-weight: 500;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .order-number {
                font-size: 2rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
                padding: 2rem;
            }

            .products-section,
            .order-summary,
            .order-header {
                padding: 2rem;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .product-row {
                grid-template-columns: 60px 1fr auto;
                gap: 0.75rem;
            }

            .product-quantity {
                grid-column: 2;
                grid-row: 2;
                text-align: left;
                margin-top: 0.5rem;
            }

            .product-total {
                grid-column: 3;
                grid-row: 1 / 3;
                align-self: center;
            }

            .action-buttons {
                flex-direction: column;
            }

            .order-type-badge {
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        /* Animation */
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Status Timeline */
        .status-timeline {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem 0;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            position: relative;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 25px;
            top: 50px;
            width: 2px;
            height: calc(100% + 1rem);
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
        }

        .timeline-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .timeline-content {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .timeline-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .timeline-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .timeline-time {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .timeline-description {
            font-size: 0.875rem;
            color: #475569;
            line-height: 1.5;
        }

        /* Timeline Icon Colors */
        .timeline-icon.status-pending {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .timeline-icon.status-approved {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .timeline-icon.status-shipping {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .timeline-icon.status-delivered {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .timeline-icon.status-cancelled {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Responsive Timeline */
        @@media (max-width: 768px) {
            .timeline-item {
                gap: 1rem;
            }

            .timeline-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .timeline-content {
                padding: 1rem;
            }

            .timeline-item:not(:last-child)::after {
                left: 20px;
                top: 40px;
            }
        }

        /* Additional fixes for better styling */
        .text-success {
            color: #059669 !important;
        }

        .text-red-500 {
            color: #ef4444 !important;
        }

        .text-gray-600 {
            color: #4b5563 !important;
        }

        .text-gray-700 {
            color: #374151 !important;
        }

        .leading-relaxed {
            line-height: 1.625;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .fw-semibold {
            font-weight: 600;
        }

        /* Container styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Breadcrumb styles */
        .breadcrumb {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: '/';
            margin: 0 0.5rem;
            color: #cbd5e1;
        }

        /* Ensure proper spacing */
        .py-16 {
            padding-top: 4rem;
            padding-bottom: 4rem;
        }

        .py-20 {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }

        /* Text utilities */
        .text-4xl {
            font-size: 2.25rem;
        }

        .text-5xl {
            font-size: 3rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .opacity-90 {
            opacity: 0.9;
        }

        /* Responsive text */
        @@media (max-width: 768px) {
            .text-4xl {
                font-size: 1.875rem;
            }
            
            .text-5xl {
                font-size: 2.25rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        // ‚úÖ G·ª≠i email h√≥a ƒë∆°n - T·ªëi ∆∞u h√≥a ƒë·ªÉ g·ª≠i trong 5 gi√¢y
        document.addEventListener('DOMContentLoaded', function() {
            const sendEmailBtn = document.getElementById('sendEmailBtn');
            if (sendEmailBtn) {
                sendEmailBtn.addEventListener('click', async function() {
                    const hoaDonId = '@Model.HoaDonId';
                    const btn = this;
                    const originalText = btn.innerHTML;
                    
                    // Show loading state
                    btn.disabled = true;
                    btn.innerHTML = '<div class="loading-spinner"></div> ƒêang g·ª≠i...';
                    
                    try {
                        // ‚úÖ T·ªëi ∆∞u h√≥a: S·ª≠ d·ª•ng AbortController ƒë·ªÉ timeout sau 15 gi√¢y
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);
                        
                        const response = await fetch(`/HoaDon/SendEmailInvoice/${hoaDonId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                // ‚úÖ Hi·ªáu ·ª©ng th√†nh c√¥ng ƒë·∫πp m·∫Øt
                                btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ g·ª≠i';
                                btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                btn.style.transform = 'scale(1.05)';
                                
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.style.background = '';
                                    btn.style.transform = '';
                                    btn.disabled = false;
                                }, 2000);
                                
                                // ‚úÖ Toast notification ƒë·∫πp m·∫Øt
                                showSuccessToast('H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! üéâ');
                            } else {
                                throw new Error(result.message || 'C√≥ l·ªói x·∫£y ra');
                            }
                        } else {
                            throw new Error('Kh√¥ng th·ªÉ g·ª≠i email');
                        }
                    } catch (error) {
                        console.error('Error sending email:', error);
                        
                        if (error.name === 'AbortError') {
                            showErrorToast('G·ª≠i email b·ªã timeout. Vui l√≤ng th·ª≠ l·∫°i sau.');
                        } else {
                            showErrorToast('C√≥ l·ªói x·∫£y ra khi g·ª≠i email. Vui l√≤ng th·ª≠ l·∫°i sau.');
                        }
                        
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                });
            }
        });

        // ‚úÖ Toast notifications ƒë·∫πp m·∫Øt
        function showSuccessToast(message) {
            showToast(message, 'success');
        }

        function showErrorToast(message) {
            showToast(message, 'error');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                </div>
                <div class="toast-message">${message}</div>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
}

<!-- Hero Section -->
<section class="hero-section text-white">
    <div class="container mx-auto px-4 relative z-10">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                Chi Ti·∫øt ƒê∆°n H√†ng
            </h1>
            <p class="text-xl opacity-90">
                Th√¥ng tin chi ti·∫øt v·ªÅ ƒë∆°n h√†ng c·ªßa b·∫°n
            </p>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-16" style="background-color: #f8fafc;">
    <div class="container mx-auto px-4">
        <!-- Breadcrumb -->
        <nav class="breadcrumb-modern">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a asp-controller="Home" asp-action="Index">
                        <i class="fas fa-home"></i> Trang ch·ªß
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a asp-controller="DonHang" asp-action="Index">
                        <i class="fas fa-shopping-bag"></i> ƒê∆°n h√†ng
                    </a>
                </li>
                <li class="breadcrumb-item active">
                    <i class="fas fa-receipt"></i> #@Model.HoaDonId.ToString().Substring(0, 8).ToUpper()
                </li>
            </ol>
        </nav>

        <!-- Order Details Container -->
        <div class="order-details-container fade-in">
            <!-- Order Header -->
            <div class="order-header">
                <div class="order-number">
                    ƒê∆°n h√†ng #@Model.HoaDonId.ToString().Substring(0, 8).ToUpper()
                    @if (Model.LoaiHoaDon == "BanTaiQuay")
                    {
                        <span class="order-type-badge order-type-offline">
                            <i class="fas fa-store me-1"></i>Kh√°ch t·∫°i qu·∫ßy
                        </span>
                    }
                    else
                    {
                        <span class="order-type-badge order-type-online">
                            <i class="fas fa-globe me-1"></i>Online
                        </span>
                    }
                </div>
                <div class="order-date">
                                            ƒê·∫∑t h√†ng l√∫c @Model.NgayTao.ToString("dd/MM/yyyy 'l√∫c' HH:mm")
                </div>
                <div class="status-badge @GetStatusClass(Model.TrangThai)">
                    <i class="fas fa-@GetStatusIcon(Model.TrangThai)"></i>
                    @Model.TrangThaiText
                </div>
            </div>

            <!-- Order Information Grid -->
            <div class="info-grid">
                <!-- Order Status -->
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="info-card-title">Th√¥ng tin ƒë∆°n h√†ng</div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">M√£ ƒë∆°n h√†ng:</span>
                        <span class="info-value">#@Model.HoaDonId.ToString().Substring(0, 8).ToUpper()</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ng√†y ƒë·∫∑t:</span>
                        <span class="info-value">@Model.NgayTao.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    @if (Model.NgayNhanHang.HasValue)
                    {
                        <div class="info-item">
                            <span class="info-label">Ng√†y nh·∫≠n:</span>
                            <span class="info-value">@Model.NgayNhanHang.Value.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    }
                    <div class="info-item">
                        <span class="info-label">Tr·∫°ng th√°i:</span>
                        <span class="info-value">@Model.TrangThaiText</span>
                    </div>
                </div>

                <!-- Payment & Delivery -->
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="info-card-title">Thanh to√°n & Giao h√†ng</div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ph∆∞∆°ng th·ª©c:</span>
                        <span class="info-value">
                            @if (Model.LoaiHoaDon == "BanTaiQuay")
                            {
                                <span class="text-success fw-semibold">ƒê√£ thanh to√°n</span>
                            }
                            else
                            {
                                @Model.HinhThucThanhToan
                            }
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                        <span class="info-value">@Model.DiaChiGiaoHang</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.VoucherCode))
                    {
                        <div class="info-item">
                            <span class="info-label">Voucher:</span>
                            <span class="info-value">@Model.VoucherCode</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.GhiChu))
                    {
                        <div class="info-item">
                            <span class="info-label">Ghi ch√∫:</span>
                            <span class="info-value">@Model.GhiChu</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Status History Section -->
        <div class="order-details-container fade-in" style="margin-top: 2rem;">
            <div class="products-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="section-title">L·ªãch s·ª≠ tr·∫°ng th√°i ƒë∆°n h√†ng</div>
                </div>

                <div class="status-timeline">
                    <!-- Order Created -->
                    <div class="timeline-item">
                        <div class="timeline-icon status-pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">ƒê∆°n h√†ng ƒë∆∞·ª£c t·∫°o</div>
                            <div class="timeline-time">@Model.NgayTao.ToString("dd/MM/yyyy HH:mm:ss")</div>
                            <div class="timeline-description">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng</div>
                        </div>
                    </div>

                    <!-- Status Changes -->
                    @if (Model.LichSuTrangThaiHoaDons != null && Model.LichSuTrangThaiHoaDons.Any())
                    {
                        var lichSuOrdered = Model.LichSuTrangThaiHoaDons.OrderBy(l => l.ThoiGianThayDoi).ToList();
                        
                        foreach (var lichSu in lichSuOrdered)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon @GetStatusClass(lichSu.TrangThaiMoi)">
                                    <i class="@GetStatusIcon(lichSu.TrangThaiMoi)"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">@GetStatusChangeText(lichSu.TrangThaiCu, lichSu.TrangThaiMoi)</div>
                                    <div class="timeline-time">@lichSu.ThoiGianThayDoi.ToString("dd/MM/yyyy HH:mm:ss")</div>
                                    @if (!string.IsNullOrEmpty(lichSu.GhiChu))
                                    {
                                        <div class="timeline-description">@lichSu.GhiChu</div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <!-- Fallback: Show basic status progression -->
                        @if (Model.TrangThai >= 1)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon status-approved">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">ƒê∆°n h√†ng ƒë∆∞·ª£c duy·ªát</div>
                                    <div class="timeline-time">
                                        @Model.NgayTao.ToString("dd/MM/yyyy HH:mm:ss")
                                    </div>
                                    <div class="timeline-description">ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n v√† ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω</div>
                                </div>
                            </div>
                        }
                        
                        @if (Model.TrangThai >= 2)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon status-shipping">
                                    <i class="fas fa-truck"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">ƒê∆°n h√†ng ƒëang giao</div>
                                    <div class="timeline-time">
                                        @Model.NgayTao.ToString("dd/MM/yyyy HH:mm:ss")
                                    </div>
                                    <div class="timeline-description">ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c v·∫≠n chuy·ªÉn ƒë·∫øn b·∫°n</div>
                                </div>
                            </div>
                        }
                        
                        @if (Model.TrangThai >= 3)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon status-delivered">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">ƒê∆°n h√†ng ƒë√£ giao</div>
                                    <div class="timeline-time">
                                        @Model.NgayTao.ToString("dd/MM/yyyy HH:mm:ss")
                                    </div>
                                    <div class="timeline-description">ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng</div>
                                </div>
                            </div>
                        }
                        
                        @if (Model.TrangThai == 4)
                        {
                            <div class="timeline-item">
                                <div class="timeline-icon status-cancelled">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">ƒê∆°n h√†ng ƒë√£ h·ªßy</div>
                                    <div class="timeline-time">@Model.NgayTao.ToString("dd/MM/yyyy HH:mm:ss")</div>
                                    <div class="timeline-description">ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy</div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="order-details-container fade-in" style="margin-top: 2rem;">
            <div class="products-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="section-title">S·∫£n ph·∫©m ƒë√£ mua</div>
                </div>

                <div class="products-grid">
                    @foreach (var product in Model.ChiTiets)
                    {
                        <div class="product-card">
                            <div class="product-row">
                                @{
                                    // ‚úÖ S·ª≠ d·ª•ng ·∫£nh snapshot n·∫øu c√≥, fallback sang ·∫£nh hi·ªán t·∫°i
                                    string imgLink = null;
                                    var snapshotImg = product.AnhSanPhamLucMua ?? string.Empty;
                                    var currentImg = product.AnhSanPham ?? string.Empty;
                                    var dd = !string.IsNullOrWhiteSpace(snapshotImg) ? snapshotImg : currentImg;

                                    if (!string.IsNullOrWhiteSpace(dd))
                                    {
                                        if (dd.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                                            imgLink = dd;
                                        else if (dd.Contains("/"))
                                            imgLink = "https://localhost:7289/" + dd.TrimStart('/');
                                        else
                                            imgLink = $"https://localhost:7289/images/{System.IO.Path.GetFileName(dd)}";
                                    }
                                }

                                @if (!string.IsNullOrEmpty(imgLink))
                                {
                                    <img src="@imgLink" class="product-image" alt="@(product.TenSanPhamLucMua ?? product.TenSanPham)" />
                                }
                                else
                                {
                                    <div class="product-image-placeholder">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                }

                                <div class="product-info">
                                    <div class="product-name">@(product.TenSanPhamLucMua ?? product.TenSanPham)</div>
                                    <div class="product-variants">
                                        <span class="variant-badge">
                                            <i class="fas fa-palette"></i> @(product.MauSacLucMua ?? product.MauSac)
                                        </span>
                                        <span class="variant-badge">
                                            <i class="fas fa-rulers"></i> @(product.KichCoLucMua ?? product.KichCo)
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        ƒê∆°n gi√°: @((product.GiaLucMua ?? product.Gia).ToString("N0")) VNƒê
                                    </div>
                                </div>

                                <div class="product-quantity">
                                    @product.SoLuong
                                </div>

                                <div class="product-total">
                                    @product.ThanhTien.ToString("N0") VNƒê
                                </div>

                                <!-- ACTION: N√∫t y√™u c·∫ßu ho√†n tr·∫£ -->

                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <div class="summary-grid">
                    <div class="summary-left">
                        @if (!string.IsNullOrEmpty(Model.VoucherCode))
                        {
                            <div class="summary-card">
                                <div class="summary-card-title">
                                    <i class="fas fa-ticket-alt"></i>
                                    Voucher √°p d·ª•ng
                                </div>
                                <div class="info-item">
                                    <span class="info-label">M√£ voucher:</span>
                                    <span class="info-value">@Model.VoucherCode</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Gi·∫£m gi√°:</span>
                                    <span class="info-value text-red-500">-@((Model.VoucherDiscount ?? 0m).ToString("N0")) VNƒê</span>
                                </div>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(Model.GhiChu))
                        {
                            <div class="summary-card">
                                <div class="summary-card-title">
                                    <i class="fas fa-sticky-note"></i>
                                    Ghi ch√∫ ƒë∆°n h√†ng
                                </div>
                                <p class="text-gray-700 leading-relaxed">@Model.GhiChu</p>
                            </div>
                        }
                    </div>

                    <div class="summary-right">
                        <div class="total-card">
                            <div class="total-breakdown">
                                <div class="total-item">
                                    <span>T·ªïng ti·ªÅn h√†ng:</span>
                                    <span>@Model.TongTien.ToString("N0") VNƒê</span>
                                </div>
                                @if (Model.VoucherDiscount.HasValue && Model.VoucherDiscount > 0)
                                {
                                    <div class="total-item text-success">
                                        <span>
                                            <i class="fas fa-ticket-alt me-1"></i>
                                            Gi·∫£m gi√°:
                                        </span>
                                        <span>-@Model.VoucherDiscount.Value.ToString("N0") VNƒê</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(Model.VoucherCode))
                                    {
                                        <div class="total-item text-muted small">
                                            <span>M√£ voucher:</span>
                                            <span>@Model.VoucherCode</span>
                                        </div>
                                    }
                                }
                                @{ 
                                    var _discount = Model.VoucherDiscount ?? 0m; 
                                    // ‚úÖ T√≠nh to√°n ph√≠ ship ƒë√∫ng: T·ªïng thanh to√°n - (T·ªïng ti·ªÅn h√†ng - Gi·∫£m gi√°)
                                    var _phiShip = Model.TongTienSauKhiGiam - (Model.TongTien - _discount);
                                    // ‚úÖ ƒê·∫£m b·∫£o ph√≠ ship kh√¥ng √¢m v√† kh√¥ng v∆∞·ª£t qu√° 30k
                                    _phiShip = Math.Max(0, Math.Min(30000, _phiShip));
                                }
                                <div class="total-item">
                                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                    <span>@_phiShip.ToString("N0") VNƒê</span>
                                </div>
                                <div class="total-item final">
                                    <span>T·ªïng thanh to√°n:</span>
                                    <span>@Model.TongTienSauKhiGiam.ToString("N0") VNƒê</span>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <a asp-controller="DonHang" asp-action="Index" class="btn-modern btn-outline">
                                    <i class="fas fa-arrow-left"></i>
                                    Quay l·∫°i
                                </a>
                                
                                <!-- ‚úÖ N√∫t g·ª≠i email h√≥a ƒë∆°n -->
                                <button class="btn-modern btn-email" id="sendEmailBtn">
                                    <i class="fas fa-envelope"></i>
                                    G·ª≠i h√≥a ƒë∆°n
                                </button>
                                
                                @if (Model.TrangThai < 3) // Ch∆∞a giao
                                {
                                    <a href="tel:0968596808" class="btn-modern btn-primary">
                                        <i class="fas fa-phone"></i>
                                        Li√™n h·ªá h·ªó tr·ª£
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@functions {
    public string GetStatusClass(int status)
    {
        return status switch
        {
            0 => "status-pending",
            1 => "status-approved", 
            2 => "status-shipping",
            3 => "status-delivered",
            4 => "status-cancelled",
            _ => "status-pending"
        };
    }

    public string GetStatusIcon(int status)
    {
        return status switch
        {
            0 => "clock",
            1 => "check",
            2 => "truck",
            3 => "check-circle",
            4 => "times-circle",
            _ => "clock"
        };
    }

    private string GetStatusChangeText(int oldStatus, int newStatus)
    {
        if (oldStatus == 0 && newStatus == 1) return "ƒê∆°n h√†ng ƒë∆∞·ª£c duy·ªát";
        if (oldStatus == 1 && newStatus == 2) return "ƒê∆°n h√†ng ƒëang giao";
        if (oldStatus == 2 && newStatus == 3) return "ƒê∆°n h√†ng ƒë√£ giao";
        if (newStatus == 4) return "ƒê∆°n h√†ng ƒë√£ h·ªßy";
        if (oldStatus == 0 && newStatus == 4) return "ƒê∆°n h√†ng ƒë√£ h·ªßy";
        if (oldStatus == 1 && newStatus == 4) return "ƒê∆°n h√†ng ƒë√£ h·ªßy";
        if (oldStatus == 2 && newStatus == 4) return "ƒê∆°n h√†ng ƒë√£ h·ªßy";
        return "Tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi";
    }
}
