
@model List<FurryFriends.Web.ViewModels.DonHangKhachHangViewModel>

@{
    ViewData["Title"] = "Qu·∫£n l√Ω ƒë∆°n h√†ng - FuryFriend";
}

@section Styles {
    <link rel="stylesheet" href="~/css/donhang.css" />
    <style>
        /* Custom Confirmation Dialog Styles */
        .custom-confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .custom-confirm-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .confirm-dialog-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .confirm-dialog-content {
            position: relative;
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .custom-confirm-dialog.show .confirm-dialog-content {
            transform: scale(1);
        }

        .confirm-dialog-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .confirm-dialog-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .confirm-dialog-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .confirm-dialog-body {
            color: #475569;
            margin-bottom: 2rem;
        }

        .confirm-dialog-warning {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            color: #92400e;
        }

        .confirm-dialog-warning ul {
            margin: 0.5rem 0 0 1.25rem;
            padding: 0;
        }

        .confirm-dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Notification Toast Styles */
        .notification-toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 10000;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .notification-content {
            background: white;
            padding: 1.25rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            border-left: 5px solid #6366f1;
            position: relative;
        }

        .notification-success .notification-content { border-left-color: #10b981; }
        .notification-error .notification-content { border-left-color: #ef4444; }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 700;
            color: #1e293b;
        }

        .notification-message {
            color: #64748b;
            font-size: 0.875rem;
        }

        .notification-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            border: none;
            background: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.25rem;
        }
    </style>
}

<!-- Hero Section -->
<section class="hero-section py-20 text-white">
    <div class="container mx-auto px-4 relative z-10">
        <div class="text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">
                Qu·∫£n L√Ω ƒê∆°n H√†ng
            </h1>
            <p class="text-xl md:text-2xl mb-8 opacity-90 max-w-3xl mx-auto">
                Theo d√µi tr·∫°ng th√°i v√† l·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa b·∫°n
            </p>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">B·ªô L·ªçc ƒê∆°n H√†ng</h3>
                <div class="text-sm text-gray-600">
                    T·ªïng: <span class="font-semibold">@Model.Count</span> ƒë∆°n h√†ng
                </div>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Tr·∫°ng th√°i</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="0">Ch·ªù duy·ªát</option>
                        <option value="1">ƒê√£ duy·ªát</option>
                        <option value="2">ƒêang giao</option>
                        <option value="3">ƒê√£ giao</option>
                        <option value="4">ƒê√£ h·ªßy</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">S·∫Øp x·∫øp</label>
                    <select class="filter-select" id="sortFilter">
                        <option value="date-desc">M·ªõi nh·∫•t</option>
                        <option value="date-asc">C≈© nh·∫•t</option>
                        <option value="amount-desc">Gi√° tr·ªã cao</option>
                        <option value="amount-asc">Gi√° tr·ªã th·∫•p</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Th·ªùi gian</label>
                    <select class="filter-select" id="timeFilter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="7">7 ng√†y qua</option>
                        <option value="30">30 ng√†y qua</option>
                        <option value="90">3 th√°ng qua</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Orders Grid -->
        @if (Model == null || !Model.Any())
        {
            <div class="empty-state fade-in">
                <div class="empty-icon">üì¶</div>
                <h3 class="empty-title">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
                <p class="empty-description">
                    B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. H√£y kh√°m ph√° c√°c s·∫£n ph·∫©m tuy·ªát v·ªùi c·ªßa ch√∫ng t√¥i!
                </p>
                <a asp-controller="SanPhamKhachHang" asp-action="Index" class="btn-modern btn-primary">
                    <i class="fas fa-shopping-bag"></i>
                    Mua s·∫Øm ngay
                </a>
            </div>
        }
        else
        {
            <div class="order-grid" id="ordersGrid">
                @foreach (var order in Model)
                {
                    <div class="order-card fade-in" 
                         data-status="@order.TrangThai" 
                         data-date="@order.NgayTao.Ticks" 
                         data-amount="@order.TongTienSauKhiGiam"
                         onclick="window.location.href='@Url.Action("Details", "DonHang", new { id = order.HoaDonId })'">
                        
                        <div class="order-header">
                            <div class="order-id">
                                ƒê∆°n h√†ng #@order.HoaDonId.ToString().Substring(0, 8).ToUpper()
                                @if (order.LoaiHoaDon == "BanTaiQuay")
                                {
                                    <span class="order-type-badge order-type-offline">
                                        <i class="fas fa-store me-1"></i>Kh√°ch t·∫°i qu·∫ßy
                                    </span>
                                }
                                else
                                {
                                    <span class="order-type-badge order-type-online">
                                        <i class="fas fa-globe me-1"></i>Online
                                    </span>
                                }
                            </div>
                            <div class="order-date">
                                @order.NgayTao.ToString("dd/MM/yyyy HH:mm")
                            </div>
                            <div class="order-status @GetStatusClass(order.TrangThai)">
                                @order.TrangThaiText
                            </div>
                        </div>

                        <div class="order-content">
                            <div class="order-summary">
                                <div class="summary-item">
                                    <i class="fas fa-boxes"></i>
                                    <div class="summary-label">S·∫£n ph·∫©m</div>
                                    <div class="summary-value">@order.ChiTiets.Sum(c => c.SoLuong)</div>
                                </div>
                                <div class="summary-item">
                                    <i class="fas fa-credit-card"></i>
                                    <div class="summary-label">Thanh to√°n</div>
                                    <div class="summary-value">
                                        @if (order.LoaiHoaDon == "BanTaiQuay")
                                        {
                                            <span class="text-success fw-semibold">ƒê√£ thanh to√°n</span>
                                        }
                                        else
                                        {
                                            @order.HinhThucThanhToan
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(order.ThongTinVoucherLucMua))
                            {
                                <div class="voucher-info mb-3">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="fas fa-ticket-alt text-success"></i>
                                        <span class="text-success fw-semibold">ƒê√£ √°p d·ª•ng voucher</span>
                                    </div>
                                    <div class="text-sm text-muted">@order.ThongTinVoucherLucMua</div>
                                </div>
                            }

                            <div class="order-products">
                                <div class="products-header">
                                    <i class="fas fa-list"></i>
                                    S·∫£n ph·∫©m ƒë√£ mua
                                </div>
                                @{
                                    var displayProducts = order.ChiTiets.Take(2);
                                    var remainingCount = order.ChiTiets.Count - 2;
                                }
                                @foreach (var product in displayProducts)
                                {
                                    <div class="product-preview">
                                        @{ 
                                            // ‚úÖ S·ª≠ d·ª•ng ·∫£nh snapshot n·∫øu c√≥, fallback sang ·∫£nh hi·ªán t·∫°i
                                            string imgLink = null; 
                                            var snapshotImg = product.AnhSanPhamLucMua ?? string.Empty;
                                            var currentImg = product.AnhSanPham ?? string.Empty;
                                            var dd = !string.IsNullOrWhiteSpace(snapshotImg) ? snapshotImg : currentImg;
                                            
                                            if (!string.IsNullOrWhiteSpace(dd)) { 
                                                if (dd.StartsWith("http", StringComparison.OrdinalIgnoreCase)) 
                                                    imgLink = dd; 
                                                else if (dd.Contains("/")) 
                                                    imgLink = "https://localhost:7289/" + dd.TrimStart('/'); 
                                                else 
                                                    imgLink = $"https://localhost:7289/images/{System.IO.Path.GetFileName(dd)}"; 
                                            } 
                                        }
                                        @if (!string.IsNullOrEmpty(imgLink)) 
                                        {
                                            <img src="@imgLink" class="product-image" alt="@(product.TenSanPhamLucMua ?? product.TenSanPham)" />
                                        }
                                        else
                                        {
                                            <div class="product-image-placeholder">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                        }
                                        <div class="product-info">
                                            <div class="product-name" title="@(product.TenSanPhamLucMua ?? product.TenSanPham)">
                                                @(product.TenSanPhamLucMua ?? product.TenSanPham)
                                            </div>
                                            <div class="product-details">
                                                @(product.MauSacLucMua ?? product.MauSac) ‚Ä¢ @(product.KichCoLucMua ?? product.KichCo)
                                            </div>
                                        </div>
                                        <div class="product-quantity">
                                            @product.SoLuong
                                        </div>
                                    </div>
                                }
                                @if (remainingCount > 0)
                                {
                                    <div class="more-products">
                                        +@remainingCount s·∫£n ph·∫©m kh√°c
                                    </div>
                                }
                            </div>

                            <div class="order-actions-container">
                            <div class="order-actions">
                                <div class="total-price">
                                    @order.TongTienSauKhiGiam.ToString("N0") VNƒê
                                </div>
                                
                                   
                              
                                
                                <!-- ‚úÖ N√∫t h·ªßy ƒë∆°n h√†ng - ch·ªâ hi·ªÉn th·ªã khi "Ch·ªù duy·ªát" ho·∫∑c "ƒê√£ duy·ªát" -->
                                @if (order.TrangThai == 0 || order.TrangThai == 1)
                                {
                                    <button class="btn-modern btn-danger cancel-order-btn" 
                                            data-order-id="@order.HoaDonId"
                                            onclick="event.stopPropagation(); confirmCancelOrder('@order.HoaDonId')">
                                        <i class="fas fa-times"></i>
                                        H·ªßy ƒë∆°n
                                    </button>
                                }
                                
                                    <!-- ‚úÖ N√∫t xem chi ti·∫øt - lu√¥n hi·ªÉn th·ªã -->
                                <a asp-action="Details" asp-route-id="@order.HoaDonId" 
                                   class="btn-modern btn-primary" 
                                   onclick="event.stopPropagation()">
                                    <i class="fas fa-eye"></i>
                                    Chi ti·∫øt
                                </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = document.getElementById('statusFilter');
        const sortFilter = document.getElementById('sortFilter');
        const timeFilter = document.getElementById('timeFilter');
        const ordersGrid = document.getElementById('ordersGrid');

        function applyFilters() {
            const cards = Array.from(document.querySelectorAll('.order-card'));
            const selectedStatus = statusFilter.value;
            const selectedSort = sortFilter.value;
            const selectedTime = timeFilter.value;

            // Filter by status
            let filteredCards = cards.filter(card => {
                if (!selectedStatus) return true;
                return card.dataset.status === selectedStatus;
            });

            // Filter by time
            if (selectedTime) {
                const daysAgo = parseInt(selectedTime);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                const cutoffTicks = cutoffDate.getTime() * 10000 + 621355968000000000; // Convert to .NET ticks

                filteredCards = filteredCards.filter(card => {
                    const cardDate = parseInt(card.dataset.date);
                    return cardDate >= cutoffTicks;
                });
            }

            // Sort cards
            filteredCards.sort((a, b) => {
                switch (selectedSort) {
                    case 'date-asc':
                        return parseInt(a.dataset.date) - parseInt(b.dataset.date);
                    case 'date-desc':
                        return parseInt(b.dataset.date) - parseInt(a.dataset.date);
                    case 'amount-asc':
                        return parseFloat(a.dataset.amount) - parseFloat(b.dataset.amount);
                    case 'amount-desc':
                        return parseFloat(b.dataset.amount) - parseFloat(a.dataset.amount);
                    default:
                        return parseInt(b.dataset.date) - parseInt(a.dataset.date);
                }
            });

            // Hide all cards first
            cards.forEach(card => card.style.display = 'none');

            // Show filtered and sorted cards
            if (filteredCards.length === 0) {
                ordersGrid.innerHTML = `
                    <div class="empty-state fade-in" style="grid-column: 1 / -1;">
                        <div class="empty-icon">üîç</div>
                        <h3 class="empty-title">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</h3>
                        <p class="empty-description">
                            Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc ƒë√£ ch·ªçn.
                        </p>
                    </div>
                `;
            } else {
                // Restore original grid
                ordersGrid.innerHTML = '';
                filteredCards.forEach(card => {
                    card.style.display = 'block';
                    ordersGrid.appendChild(card);
                });
            }
        }

        statusFilter.addEventListener('change', applyFilters);
        sortFilter.addEventListener('change', applyFilters);
        timeFilter.addEventListener('change', applyFilters);
    });

    // ‚úÖ H√†m x√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng
    function confirmCancelOrder(orderId) {
        // ‚úÖ T·∫°o custom confirmation dialog ƒë·∫πp h∆°n
        const confirmDialog = document.createElement('div');
        confirmDialog.className = 'custom-confirm-dialog';
        confirmDialog.innerHTML = `
            <div class="confirm-dialog-overlay"></div>
            <div class="confirm-dialog-content">
                <div class="confirm-dialog-header">
                    <div class="confirm-dialog-icon">‚ö†Ô∏è</div>
                    <h3 class="confirm-dialog-title">X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng</h3>
                </div>
                <div class="confirm-dialog-body">
                    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?</p>
                    <div class="confirm-dialog-warning">
                        <strong>L∆∞u √Ω:</strong>
                        <ul>
                            <li>‚úÖ S·ªë l∆∞·ª£ng s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c c·ªông l·∫°i v√†o kho</li>
                            <li>‚ùå H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c</li>
                            <li>üîÑ ƒê∆°n h√†ng s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i "ƒê√£ h·ªßy"</li>
                        </ul>
                    </div>
                </div>
                <div class="confirm-dialog-actions">
                    <button class="btn-modern btn-secondary" onclick="closeConfirmDialog()">
                        <i class="fas fa-times"></i>
                        H·ªßy b·ªè
                    </button>
                    <button class="btn-modern btn-danger" onclick="proceedCancelOrder('${orderId}')">
                        <i class="fas fa-check"></i>
                        X√°c nh·∫≠n h·ªßy
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(confirmDialog);
        
        // Hi·ªÉn th·ªã v·ªõi animation
        setTimeout(() => {
            confirmDialog.classList.add('show');
        }, 10);
    }

    // ‚úÖ H√†m ƒë√≥ng dialog x√°c nh·∫≠n
    function closeConfirmDialog() {
        const dialog = document.querySelector('.custom-confirm-dialog');
        if (dialog) {
            dialog.classList.remove('show');
            setTimeout(() => dialog.remove(), 300);
        }
    }

    // ‚úÖ H√†m th·ª±c hi·ªán h·ªßy ƒë∆°n h√†ng sau khi x√°c nh·∫≠n
    function proceedCancelOrder(orderId) {
        closeConfirmDialog();
        cancelOrder(orderId);
    }

    // ‚úÖ H√†m th·ª±c hi·ªán h·ªßy ƒë∆°n h√†ng
    async function cancelOrder(orderId) {
        // Khai b√°o bi·∫øn ·ªü ngo√†i ƒë·ªÉ d√πng trong catch
        const cancelBtn = document.querySelector(`[data-order-id="${orderId}"]`);
        if (!cancelBtn) return;
        
        const originalText = cancelBtn.innerHTML;
        
        try {
            // Hi·ªÉn th·ªã loading
            cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang h·ªßy...';
            cancelBtn.disabled = true;

            // G·ªçi API h·ªßy ƒë∆°n h√†ng
            const response = await fetch(`/DonHang/HuyDonHang?hoaDonId=${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const result = await response.json();

            if (result.success) {
                // ‚úÖ H·ªßy th√†nh c√¥ng
                showNotification('‚úÖ ' + result.message, 'success');
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng tr√™n UI
                setTimeout(() => {
                    location.reload(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                }, 1500);
            } else {
                // ‚ùå H·ªßy th·∫•t b·∫°i
                showNotification('‚ùå ' + result.message, 'error');
                
                // Kh√¥i ph·ª•c n√∫t
                cancelBtn.innerHTML = originalText;
                cancelBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error canceling order:', error);
            showNotification('‚ùå L·ªói khi h·ªßy ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
            
            // Kh√¥i ph·ª•c n√∫t
            cancelBtn.innerHTML = originalText;
            cancelBtn.disabled = false;
        }
    }

    // ‚úÖ H√†m hi·ªÉn th·ªã th√¥ng b√°o ƒë·∫πp
    function showNotification(message, type = 'info') {
        // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
        const existingNotification = document.querySelector('.notification-toast');
        if (existingNotification) {
            existingNotification.remove();
        }

        // ‚úÖ Icon v√† title theo lo·∫°i th√¥ng b√°o
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };

        const titles = {
            success: 'Th√†nh c√¥ng!',
            error: 'L·ªói!',
            warning: 'C·∫£nh b√°o!',
            info: 'Th√¥ng b√°o'
        };

        // T·∫°o th√¥ng b√°o m·ªõi v·ªõi icon v√† title
        const notification = document.createElement('div');
        notification.className = `notification-toast notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <div class="notification-header">
                    <span class="notification-icon">${icons[type]}</span>
                    <span class="notification-title">${titles[type]}</span>
                </div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
            </div>
        `;

        // Th√™m v√†o body
        document.body.appendChild(notification);

        // Hi·ªÉn th·ªã v·ªõi animation slide-in
        setTimeout(() => {
            notification.classList.add('slide-in');
            notification.classList.add('show');
        }, 10);

        // T·ª± ƒë·ªông ·∫©n sau 6 gi√¢y (tƒÉng th·ªùi gian hi·ªÉn th·ªã)
        setTimeout(() => {
            notification.classList.add('slide-out');
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 6000);
    }



 

    // ‚úÖ Toast notifications ƒë·∫πp m·∫Øt
    function showSuccessToast(message) {
        showToast(message, 'success');
    }

    function showErrorToast(message) {
        showToast(message, 'error');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            </div>
            <div class="toast-message">${message}</div>
        `;
        
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto remove
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }
</script>

@functions {
    public string GetStatusClass(int status)
    {
        return status switch
        {
            0 => "status-pending",
            1 => "status-approved",
            2 => "status-shipping",
            3 => "status-delivered",
            4 => "status-cancelled",
            _ => "status-pending"
        };
    }
}
