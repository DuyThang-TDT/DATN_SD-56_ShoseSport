@model List<FurryFriends.Web.ViewModels.SanPhamViewModel>
@using FurryFriends.Web.Services

@{
    ViewData["Title"] = "Sản phẩm - FuryFriend";
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger">
            @ViewBag.ErrorMessage
        </div>
    }

}

@section Styles {
    <style>
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

            .hero-section::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
                opacity: 0.3;
            }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
            align-items: stretch;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

            .product-card:hover {
                transform: translateY(-10px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            }

            .product-card:active {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            }

        .product-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-info {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .product-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
            flex: 1;
            margin-right: 0.5rem;
        }

        .view-detail-indicator {
            color: #6b7280;
            font-size: 0.875rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .product-card:hover .view-detail-indicator {
            opacity: 1;
            color: #667eea;
        }

        .product-description {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.625rem; /* 2 lines * 1.5 line-height * 0.875rem font-size */
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: #10b981;
            margin-bottom: 1rem;
            min-height: 3.5rem; /* Đảm bảo chiều cao tối thiểu cho phần giá */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .price-with-discount {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            height: 100%;
            justify-content: center;
        }

        .original-price {
            font-size: 1rem;
            color: #6b7280;
            text-decoration: line-through;
            font-weight: 500;
        }

        .discounted-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: #ef4444;
        }

        .discount-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            align-self: flex-start;
        }

        .discount-badge-top {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .discount-text {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .discount-percentage {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .product-variants {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            min-height: 2rem; /* Đảm bảo chiều cao tối thiểu cho variants */
        }

        .variant-badge {
            background: #f1f5f9;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .add-to-cart-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: auto; /* Đẩy button xuống dưới cùng */
        }

            .add-to-cart-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            }

            .add-to-cart-btn:active {
                transform: translateY(0);
            }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

            .filter-select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        /* Modal Styles */
        .variant-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1rem;
        }

            .variant-modal.show {
                display: flex;
            }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @@keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }

            .modal-close:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(1.1);
            }

        .modal-body {
            padding: 2rem;
        }

        .product-preview {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 15px;
        }

        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }

        .preview-info h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }

        .preview-info p {
            margin: 0;
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .variant-options {
            margin-bottom: 2rem;
        }

        .variant-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

            .variant-option:hover {
                border-color: #667eea;
                background: #f8fafc;
            }

            .variant-option.selected {
                border-color: #667eea;
                background: #f0f4ff;
            }

            .variant-option input[type="radio"] {
                display: none;
            }

        .variant-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variant-specs {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .variant-spec {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .variant-price {
            font-weight: 700;
            color: #10b981;
            font-size: 1.125rem;
        }

        .quantity-section {
            margin-bottom: 2rem;
        }

        .quantity-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .quantity-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

            .quantity-input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
        }

        .btn-cancel {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            background: white;
            color: #64748b;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .btn-cancel:hover {
                background: #f8fafc;
                border-color: #d1d5db;
            }

        .btn-add-cart {
            flex: 2;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .btn-add-cart:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            }

            .btn-add-cart:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        /* Responsive */
        @@media (max-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .filter-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .filter-group {
                gap: 0.75rem;
            }

            .filter-label {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }

            .filter-select {
                padding: 0.875rem 1rem;
                font-size: 1rem;
            }

            .double-range {
                padding: 20px 0 10px;
            }

            .range-values {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }

            .range-pill {
                font-size: 0.875rem;
                padding: 0.5rem 1rem;
            }

            .modal-content {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }

            .product-preview {
                flex-direction: column;
                text-align: center;
            }

            .preview-image {
                width: 80px;
                height: 80px;
                margin: 0 auto;
            }

            .modal-footer {
                flex-direction: column;
            }
        }

        @@media (max-width: 480px) {
            .filter-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .filter-section {
                padding: 1rem;
            }

            .filter-select {
                padding: 1rem;
                font-size: 1rem;
            }

            .double-range {
                padding: 16px 0 8px;
            }

            .range-pill {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            /* Sửa lỗi layout cho mobile nhỏ */
            .filter-section .flex.justify-between {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .filter-section .text-sm {
                font-size: 0.75rem;
                text-align: center;
                width: 100%;
            }
            
            .filter-section h3 {
                font-size: 1.25rem;
                text-align: center;
                width: 100%;
            }
            
            /* Đảm bảo input fields không bị cắt */
            .filter-select, input[type="number"] {
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Sửa layout cho price range inputs */
            .flex.gap-2.mt-3 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .flex.gap-2.mt-3 input {
                width: 100%;
            }
            
            /* Đảm bảo range values hiển thị đầy đủ */
            .range-values {
                flex-direction: row;
                justify-content: space-between;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .range-pill {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
        
        @@media (max-width: 360px) {
            .filter-section {
                padding: 0.75rem;
            }
            
            .filter-section h3 {
                font-size: 1.1rem;
            }
            
            .filter-label {
                font-size: 0.8rem;
            }
            
            .filter-select {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .range-pill {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
                min-width: 100px;
            }
            
            .double-range {
                padding: 12px 0 6px;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* dual range slider */
        .double-range {
            position: relative;
            width: 100%;
            padding: 14px 0 6px;
        }

            .double-range .slider-track {
                position: absolute;
                height: 8px;
                width: 100%;
                top: 18px;
                left: 0;
                right: 0;
                background: linear-gradient(to right, #e5e7eb 0%, #e5e7eb 100%);
                border-radius: 999px;
            }

            .double-range input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                position: absolute;
                left: 0;
                right: 0;
                width: 100%;
                background: none;
                pointer-events: none;
                height: 8px;
                margin: 0;
                top: 14px;
            }

                .double-range input[type="range"]::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    height: 22px;
                    width: 22px;
                    border-radius: 999px;
                    background: white;
                    border: 4px solid #3b82f6;
                    box-shadow: 0 2px 6px rgba(0,0,0,.12);
                    pointer-events: auto;
                    cursor: pointer;
                }

                .double-range input[type="range"]::-moz-range-thumb {
                    height: 22px;
                    width: 22px;
                    border-radius: 999px;
                    background: white;
                    border: 4px solid #3b82f6;
                    box-shadow: 0 2px 6px rgba(0,0,0,.12);
                    pointer-events: auto;
                    cursor: pointer;
                }

                .double-range input[type="range"]::-webkit-slider-runnable-track {
                    height: 8px;
                }

                .double-range input[type="range"]::-moz-range-track {
                    height: 8px;
                    background: none;
                }

        .range-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .range-pill {
            background: #eaf2ff;
            color: #111827;
            border-radius: 12px;
            padding: 8px 14px;
            font-weight: 600;
            box-shadow: inset 0 -2px 0 rgba(59,130,246,.15);
        }
    </style>
}

<!-- Hero Section -->
<section class="hero-section py-20 text-white">
    <div class="container mx-auto px-4 relative z-10">
        <div class="text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">
                Khám Phá Sản Phẩm
            </h1>
            <p class="text-xl md:text-2xl mb-8 opacity-90 max-w-3xl mx-auto">
                Bộ sưu tập đa dạng các sản phẩm chất lượng cao cho thú cưng của bạn
            </p>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Bộ Lọc Sản Phẩm</h3>
                <div class="text-sm text-gray-600 flex items-center gap-2">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>Click vào sản phẩm để xem chi tiết</span>
                </div>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Tìm sản phẩm</label>
                    <input list="productSuggest" id="searchInput" class="filter-select" placeholder="Nhập tên sản phẩm..." />
                    <datalist id="productSuggest">
                        @foreach (var spName in Model.Select(m => m.TenSanPham).Distinct())
                        {
                            <option value="@spName"></option>
                        }
                    </datalist>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Thương hiệu</label>
                    <select class="filter-select" id="brandFilter">
                        <option value="">Tất cả thương hiệu</option>
                        @foreach (var brand in Model.Where(m => !string.IsNullOrEmpty(m.TenThuongHieu)).Select(m => m.TenThuongHieu).Distinct())
                        {
                            <option value="@brand">@brand</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Khoảng giá (VNĐ)</label>
                    <div class="double-range">
                        <div class="slider-track" id="priceTrack"></div>
                        <input type="range" id="minRange" min="0" max="0" value="0" step="1000" />
                        <input type="range" id="maxRange" min="0" max="0" value="0" step="1000" />
                    </div>
                    <div class="range-values">
                        <span class="range-pill" id="minRangeLabel">0 VNĐ</span>
                        <span class="range-pill" id="maxRangeLabel">0 VNĐ</span>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <input type="number" id="minPrice" class="filter-select" placeholder="Từ" min="0" />
                        <input type="number" id="maxPrice" class="filter-select" placeholder="Đến" min="0" />
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sắp xếp</label>
                    <select class="filter-select" id="sortFilter">
                        <option value="">Mặc định</option>
                        <option value="price-asc">Giá tăng dần</option>
                        <option value="price-desc">Giá giảm dần</option>
                        <option value="on-sale">Đang giảm giá</option>
                        <option value="name-asc">Tên A-Z</option>
                        <option value="name-desc">Tên Z-A</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        @if (Model == null || !Model.Any())
        {
            <div class="text-center py-20">
                <div class="text-6xl mb-4">🐾</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Không tìm thấy sản phẩm</h3>
                <p class="text-gray-600">Hãy thử điều chỉnh bộ lọc hoặc quay lại sau</p>
            </div>
        }
        else
        {
            <div class="product-grid">
                @foreach (var sanPham in Model)
                {
                    <div class="product-card" data-product-id="@sanPham.SanPhamId" onclick="goToProductDetail('@sanPham.SanPhamId')" style="cursor: pointer;" title="Click để xem chi tiết sản phẩm" data-name="@sanPham.TenSanPham" data-brand="@sanPham.TenThuongHieu" data-min-price="@sanPham.ChiTietList.Min(c => c.GiaBan)" data-max-price="@sanPham.ChiTietList.Max(c => c.GiaBan)">
                        @{
                            var (coGiamGia, minGiaSauGiam, maxGiaSauGiam) = DiscountService.CalculateSafeDiscountRange(sanPham.ChiTietList);
                        }
                        @if (coGiamGia)
                        {
                            <div class="discount-badge-top">
                                <span class="discount-text">Đang giảm giá</span>
                                <span class="discount-percentage">-@(sanPham.PhanTramGiamGia?.ToString("0") ?? "0")%</span>
                            </div>
                        }
                        <img src="@($"https://localhost:7289/images/{System.IO.Path.GetFileName(sanPham.AnhDaiDienUrl)}")"
                             class="product-image"
                             alt="@sanPham.TenSanPham" />

                        <div class="product-info">
                            <div class="product-header">
                                <h3 class="product-title">@sanPham.TenSanPham</h3>
                                <div class="view-detail-indicator">
                                    <i class="fas fa-external-link-alt"></i>
                                </div>
                            </div>
                            <p class="product-description">@sanPham.MoTa</p>

                            <div class="product-meta">
                                @if (!string.IsNullOrEmpty(sanPham.TenThuongHieu))
                                {
                                    <span><strong>Thương hiệu:</strong> @sanPham.TenThuongHieu</span>
                                }
                                <span>@sanPham.ChiTietList.Sum(c => c.SoLuongTon) còn hàng</span>
                            </div>

                            <div class="product-variants">
                                @foreach (var chiTiet in sanPham.ChiTietList.Take(3))
                                {
                                    <span class="variant-badge">@chiTiet.MauSac - @chiTiet.KichCo</span>
                                }
                                @if (sanPham.ChiTietList.Count > 3)
                                {
                                    <span class="variant-badge">+@(sanPham.ChiTietList.Count - 3) khác</span>
                                }
                            </div>

                            <div class="product-price">
                                @{
                                    var minPrice = sanPham.ChiTietList.Min(c => c.GiaBan);
                                    var maxPrice = sanPham.ChiTietList.Max(c => c.GiaBan);
                                }
                                @if (coGiamGia)
                                {
                                    <div class="price-with-discount">
                                        <span class="original-price">
                                            @if (minPrice == maxPrice)
                                            {
                                                @(minPrice.ToString("N0") + " VNĐ")
                                            }
                                            else
                                            {
                                                @(minPrice.ToString("N0") + " VNĐ - " + maxPrice.ToString("N0") + " VNĐ")
                                            }
                                        </span>
                                        <span class="discounted-price">
                                            @if (minGiaSauGiam == maxGiaSauGiam)
                                            {
                                                @(minGiaSauGiam?.ToString("N0") + " VNĐ")
                                            }
                                            else
                                            {
                                                @(minGiaSauGiam?.ToString("N0") + " VNĐ - " + maxGiaSauGiam?.ToString("N0") + " VNĐ")
                                            }
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    @if (minPrice == maxPrice)
                                    {
                                        @(minPrice.ToString("N0") + " VNĐ")
                                    }
                                    else
                                    {
                                        @(minPrice.ToString("N0") + " VNĐ - " + maxPrice.ToString("N0") + " VNĐ")
                                    }
                                }
                            </div>

                            <button class="add-to-cart-btn" onclick="event.stopPropagation(); openVariantModal('@sanPham.SanPhamId', '@sanPham.TenSanPham')">
                                <i class="fas fa-cart-plus"></i>
                                Mua hàng
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</section>

<!-- Variant Selection Modal -->
<div id="variantModal" class="variant-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Chọn biến thể sản phẩm</h3>
            <button class="modal-close" onclick="closeVariantModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="product-preview">
                <img id="modalProductImage" class="preview-image" src="" alt="" />
                <div class="preview-info">
                    <h4 id="modalProductName"></h4>
                    <p id="modalProductDescription"></p>
                </div>
            </div>

            <div class="variant-options">
                <h4 class="text-lg font-semibold mb-3">Chọn biến thể:</h4>
                <div id="variantOptionsList">
                    <!-- Variants will be loaded here -->
                </div>
            </div>

            <div class="quantity-section">
                <label class="quantity-label">Số lượng:</label>
                <input type="number" id="quantityInput" class="quantity-input" value="1" min="1" />
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeVariantModal()">
                <i class="fas fa-times mr-2"></i>Hủy
            </button>
            <button class="btn-add-cart" id="addToCartBtn" onclick="addToCart()" disabled>
                <i class="fas fa-cart-plus mr-2"></i>Thêm vào giỏ
            </button>
        </div>
    </div>
</div>

<script>

    // Global variables
    let currentProductId = null;
    let selectedVariantId = null;
    let productData = {};

    // Function to go to product detail page
    function goToProductDetail(productId) {
        window.location.href = `/SanPhamKhachHang/ChiTiet/${productId}`;
    }

    // Initialize product data when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize product data
        @foreach (var sanPham in Model)
        {
                <text>
                productData['@sanPham.SanPhamId'] = {
                    id: '@sanPham.SanPhamId',
                    name: '@Html.Raw(JavaScriptStringEncode(sanPham.TenSanPham))',
                    description: '@Html.Raw(JavaScriptStringEncode(sanPham.MoTa))',
                    imageUrl: '@($"https://localhost:7289/images/{System.IO.Path.GetFileName(sanPham.AnhDaiDienUrl)}")',
                    variants: [
                        @foreach (var chiTiet in sanPham.ChiTietList)
                        {
                                <text>
                                {
                                    id: '@chiTiet.SanPhamChiTietId',
                                    color: '@chiTiet.MauSac',
                                    size: '@chiTiet.KichCo',
                                    price: @chiTiet.GiaBan,
                                    hasDiscount: @chiTiet.CoGiamGia.ToString().ToLower(),
                                    discountPrice: @((chiTiet.GiaSauGiam ?? chiTiet.GiaBan)),
                                    stock: @chiTiet.SoLuongTon,
                                    available: @chiTiet.SoLuongTon.ToString().ToLower()
                                },
                                </text>
                        }
                    ]
                };
                </text>
        }

        // Initialize event listeners
        initializeEventListeners();
    });

    function formatCurrency(n) { try { return Number(n).toLocaleString('vi-VN'); } catch { return n; } }

    // Global functions
    function openVariantModal(productId, productName) {
        console.log('Opening modal for product:', productId);
        currentProductId = productId;
        const product = productData[productId];

        if (!product) {
            console.error('Product not found:', productId);
            return;
        }

        // Update modal content
        document.getElementById('modalProductImage').src = product.imageUrl;
        document.getElementById('modalProductName').textContent = product.name;
        document.getElementById('modalProductDescription').textContent = product.description;

        // Generate variant options
        const variantsList = document.getElementById('variantOptionsList');
        variantsList.innerHTML = '';

        product.variants.forEach(variant => {
            const variantDiv = document.createElement('div');
            variantDiv.className = 'variant-option';
            variantDiv.onclick = () => selectVariant(variant.id, variantDiv);

            const priceHtml = variant.hasDiscount
                ? `<span class="line-through text-gray-400 mr-2">${formatCurrency(variant.price)} VNĐ</span>
                   <span class="text-green-600 font-bold">${formatCurrency(variant.discountPrice)} VNĐ</span>`
                : `${formatCurrency(variant.price)} VNĐ`;

            variantDiv.innerHTML = `
                <input type="radio" name="variant" value="${variant.id}" id="variant-${variant.id}" />
                <div class="variant-details">
                    <div class="variant-specs">
                        <div class="variant-spec">
                            <i class="fas fa-palette"></i>
                            <span>${variant.color}</span>
                        </div>
                        <div class="variant-spec">
                            <i class="fas fa-rulers"></i>
                            <span>${variant.size}</span>
                        </div>
                        <div class="variant-spec">
                            <i class="fas fa-box"></i>
                            <span>${variant.stock} còn</span>
                        </div>
                    </div>
                    <div class="variant-price">${priceHtml}</div>
                </div>
            `;

            variantsList.appendChild(variantDiv);
        });

        // Show modal
        document.getElementById('variantModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeVariantModal() {
        document.getElementById('variantModal').classList.remove('show');
        document.body.style.overflow = '';
        selectedVariantId = null;
        document.getElementById('addToCartBtn').disabled = true;
    }

    function selectVariant(variantId, element) {
        // Remove previous selection
        document.querySelectorAll('.variant-option').forEach(opt => {
            opt.classList.remove('selected');
        });

        // Add selection to clicked element
        element.classList.add('selected');

        // Update radio button
        document.getElementById(`variant-${variantId}`).checked = true;

        selectedVariantId = variantId;
        document.getElementById('addToCartBtn').disabled = false;
    }

    function addToCart() {
        if (!selectedVariantId || !currentProductId) {
            alert('Vui lòng chọn biến thể sản phẩm');
            return;
        }

        const quantity = parseInt(document.getElementById('quantityInput').value);
        if (quantity < 1) {
            alert('Số lượng phải lớn hơn 0');
            return;
        }

        // Get the selected product
        const product = productData[currentProductId];
        if (!product) {
            alert('Sản phẩm không tồn tại');
            return;
        }

        // ✅ Kiểm tra trạng thái sản phẩm
        if (product.trangThai === 0) {   // giả sử 0 = Không hoạt động
            alert('Sản phẩm này đã tạm ngừng hoạt động');
            return;
        }

        // Get the selected variant
        const variant = product.variants.find(v => v.id === selectedVariantId);
        if (!variant) {
            alert('Không tìm thấy biến thể đã chọn');
            return;
        }

        if (quantity > variant.stock) {
            alert(`Chỉ còn ${variant.stock} sản phẩm trong kho`);
            return;
        }

        // Create form data
        const formData = new FormData();
        formData.append('SanPhamId', currentProductId);
        formData.append('SanPhamChiTietId', selectedVariantId);
        formData.append('SoLuong', quantity);

        // Show loading state
        const btn = document.getElementById('addToCartBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span> Đang thêm...';
        btn.disabled = true;

        // Submit form
        fetch('/GioHangs/AddToCart', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        
        .then(async response => {
        const data = await response.json().catch(() => ({}));

        if (!response.ok || data.success === false) {
            // Kiểm tra nếu cần chuyển hướng đến trang đăng nhập
            if (response.status === 401 && data.redirectToLogin) {
                window.location.href = '/KhachHangLogin/DangNhap';
                return null; // Return null để không thực hiện .then() tiếp theo
            }
            
            let msg = data.message || "Có lỗi xảy ra";
            msg = msg.replace(/^API lỗi: 400 -\s*/i, "");
            throw new Error(msg); // 🚨 nhảy xuống catch, không chạy tiếp flow thành công
        }

        return data; // ✅ chỉ return khi thành công
        })
        .then(data => {
            // Chỉ thực hiện nếu data không null (không phải trường hợp redirect)
            if (data) {
                console.log("Thêm vào giỏ thành công", data);
                showNotification('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                closeVariantModal();
                if (window.refreshCartCount) window.refreshCartCount();
            }
        })
        .catch(error => {
            alert(error.message); // ❌ chỉ hiện 1 lần, không chạy success
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }


    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 transform translate-x-full transition-transform duration-300 ${
            type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function updateCartCount() {
        // This function can be implemented to update cart count in header
        // For now, we'll just show a notification
    }

    function initializeEventListeners() {
        // Close modal when clicking outside
        const modal = document.getElementById('variantModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVariantModal();
                }
            });
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeVariantModal();
            }
        });

        // Filter functionality
        const grid = document.querySelector('.product-grid');
        const cards = Array.from(document.querySelectorAll('.product-card'));

        function applyFilters(){
            const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
            const brand = (document.getElementById('brandFilter')?.value || '').trim().toLowerCase();
            const min = parseInt(document.getElementById('minPrice')?.value || '0');
            const max = parseInt(document.getElementById('maxPrice')?.value || '0');
            const sort = document.getElementById('sortFilter')?.value || '';

            let filtered = cards.filter(card => {
                const name = (card.dataset.name || '').toLowerCase();
                const bd = (card.dataset.brand || '').toLowerCase();
                // dùng giá thấp nhất để so sánh khi lọc
                const pmin = parseFloat(card.dataset.minPrice || '0');
                const pmax = parseFloat(card.dataset.maxPrice || '0');

                if (q && !name.includes(q)) return false;
                if (brand && bd !== brand.toLowerCase()) return false;

                // range inclusive
                if (!isNaN(min) && min>0 && pmax < min) return false;
                if (!isNaN(max) && max>0 && pmin > max) return false;
                return true;
            });

            // sort
            if (sort === 'price-asc') filtered.sort((a,b)=> parseFloat(a.dataset.minPrice)-parseFloat(b.dataset.minPrice));
            else if (sort === 'price-desc') filtered.sort((a,b)=> parseFloat(b.dataset.minPrice)-parseFloat(a.dataset.minPrice));
            else if (sort === 'on-sale') {
                // Ưu tiên sản phẩm đang giảm giá (có badge), sau đó giữ thứ tự theo tên
                filtered.sort((a,b)=>{
                    const aSale = a.querySelector('.discount-badge-top') ? 1 : 0;
                    const bSale = b.querySelector('.discount-badge-top') ? 1 : 0;
                    if (bSale !== aSale) return bSale - aSale; // true trước
                    return (a.dataset.name||'').localeCompare(b.dataset.name||'');
                });
            }
            else if (sort === 'name-asc') filtered.sort((a,b)=> (a.dataset.name||'').localeCompare(b.dataset.name||''));
            else if (sort === 'name-desc') filtered.sort((a,b)=> (b.dataset.name||'').localeCompare(a.dataset.name||''));

            // render
            if (grid){
                grid.innerHTML='';
                filtered.forEach(el=> grid.appendChild(el));
            }
        }

        ['searchInput','brandFilter','minPrice','maxPrice','sortFilter','minRange','maxRange'].forEach(id=>{
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', applyFilters);
            el.addEventListener('change', applyFilters);
        });

        // keep number inputs in sync when typed manually
        const minPriceInput = document.getElementById('minPrice');
        const maxPriceInput = document.getElementById('maxPrice');
        const minRangeEl = document.getElementById('minRange');
        const maxRangeEl = document.getElementById('maxRange');
        function syncFromNumbers(){
            if (minPriceInput && minRangeEl) minRangeEl.value = minPriceInput.value || minRangeEl.min;
            if (maxPriceInput && maxRangeEl) maxRangeEl.value = maxPriceInput.value || maxRangeEl.max;
        }
        minPriceInput?.addEventListener('input', ()=>{ syncFromNumbers(); applyFilters(); });
        maxPriceInput?.addEventListener('input', ()=>{ syncFromNumbers(); applyFilters(); });

        // đồng bộ range <-> number
        function syncRanges(){
            const pricesMin = cards.map(c=> parseFloat(c.dataset.minPrice||'0')).filter(n=>!isNaN(n));
            const pricesMax = cards.map(c=> parseFloat(c.dataset.maxPrice||'0')).filter(n=>!isNaN(n));
            const minAll = pricesMin.length? Math.min(...pricesMin) : 0;
            const maxAll = pricesMax.length? Math.max(...pricesMax) : 0;
            const minRange = document.getElementById('minRange');
            const maxRange = document.getElementById('maxRange');
            const track = document.getElementById('priceTrack');
            const minLbl = document.getElementById('minRangeLabel');
            const maxLbl = document.getElementById('maxRangeLabel');
            if (minRange && maxRange){
                minRange.min = minAll; minRange.max = maxAll; minRange.value = minAll;
                maxRange.min = minAll; maxRange.max = maxAll; maxRange.value = maxAll;
                document.getElementById('minPrice').value = '';
                document.getElementById('maxPrice').value = '';
                function clamp(){
                    if (parseInt(minRange.value) > parseInt(maxRange.value)){
                        const t = minRange.value; minRange.value = maxRange.value; maxRange.value = t;
                    }
                }
                function fmt(n){
                    return new Intl.NumberFormat('vi-VN').format(parseInt(n||'0')) + ' VNĐ';
                }
                function paint(){
                    const min = ((parseInt(minRange.value)-minAll)/(maxAll-minAll))*100;
                    const max = ((parseInt(maxRange.value)-minAll)/(maxAll-minAll))*100;
                    if (track) track.style.background = `linear-gradient(to right, #e5e7eb ${min}%, #93c5fd ${min}%, #93c5fd ${max}%, #e5e7eb ${max}%)`;
                    if (minLbl) minLbl.textContent = fmt(minRange.value);
                    if (maxLbl) maxLbl.textContent = fmt(maxRange.value);
                }
                const onInput = ()=>{ clamp(); document.getElementById('minPrice').value = minRange.value; document.getElementById('maxPrice').value = maxRange.value; paint(); applyFilters(); };
                minRange.addEventListener('input', onInput);
                maxRange.addEventListener('input', onInput);
                paint();
            }
        }
        syncRanges();

        // gợi ý khi gõ: datalist đã có, chỉ cần filter realtime
        applyFilters();
    }
</script>

@functions {
    public static string JavaScriptStringEncode(string value)
    {
        if (string.IsNullOrEmpty(value))
            return string.Empty;

        return value.Replace("\\", "\\\\")
                   .Replace("'", "\\'")
                   .Replace("\"", "\\\"")
                   .Replace("\r", "\\r")
                   .Replace("\n", "\\n")
                   .Replace("\t", "\\t");
    }
}

