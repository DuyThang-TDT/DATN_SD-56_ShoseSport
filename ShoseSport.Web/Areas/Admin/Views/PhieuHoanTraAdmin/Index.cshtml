@model IEnumerable<FurryFriends.Web.ViewModels.PhieuHoanTraViewModel>
@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản trị - Phiếu hoàn trả";
    var hoaDonId = (Guid)(ViewBag.HoaDonId ?? Guid.Empty);
}

@section Styles {
    <style>
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: #e2e8f0;
            --grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            --grad-success: linear-gradient(135deg,#10b981 0%,#059669 100%);
            --grad-warning: linear-gradient(135deg,#f59e0b 0%,#d97706 100%);
            --grad-danger: linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
        }

        .admin-dashboard {
            max-width: 1400px;
            margin: 2rem auto;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,.15);
            overflow: hidden;
        }

        .dashboard-header {
            background: var(--grad);
            color: #fff;
            padding: 2rem 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .dashboard-header h2 {
                margin: 0;
            font-weight: 800;
            font-size: 2rem;
            position: relative;
            z-index: 1;
        }

        .dashboard-subtitle {
            opacity: 0.9;
            font-size: 1rem;
            margin-top: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* Statistics Cards */
        .stats-section {
            padding: 2rem 2.5rem;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,.08);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,.15);
        }

        .stat-card.pending {
            border-left: 4px solid var(--warning);
        }

        .stat-card.approved {
            border-left: 4px solid var(--success);
        }

        .stat-card.rejected {
            border-left: 4px solid var(--danger);
        }

        .stat-card.total {
            border-left: 4px solid var(--primary);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .stat-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            opacity: 0.1;
        }

        /* Toolbar */
        .toolbar {
            padding: 1.5rem 2.5rem;
            border-bottom: 1px solid var(--border);
            background: white;
        }

        .toolbar-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .search-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            padding-left: 2.5rem;
            border-radius: 10px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }

        .filter-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .filter-select, .filter-date {
            border-radius: 8px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-date:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }

        .btn-filter {
            background: var(--grad);
            border: none;
            color: white;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .toolbar-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Table */
        .table-section {
            padding: 1.5rem 2.5rem;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,.08);
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: #f8fafc;
            border: none;
            padding: 1rem;
            font-weight: 700;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 1rem;
            border: none;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .product-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-details h6 {
            margin: 0;
            font-weight: 600;
            color: #1f2937;
        }

        .product-details small {
            color: #6b7280;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: var(--grad-warning);
            color: white;
        }

        .status-approved {
            background: var(--grad-success);
            color: white;
        }

        .status-rejected {
            background: var(--grad-danger);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-action {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-view {
            background: var(--grad);
            color: white;
        }

        .btn-approve {
            background: var(--grad-success);
            color: white;
        }

        .btn-reject {
            background: var(--grad-danger);
            color: white;
        }

        .btn-delete {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,.2);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .dashboard-header {
                padding: 1.5rem;
            }

            .stats-section {
                padding: 1.5rem;
            }

            .toolbar {
                padding: 1rem 1.5rem;
            }

            .toolbar-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
            }

            .table-section {
                padding: 1rem 1.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
}

<div class="admin-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <h2><i class="fas fa-clipboard-list me-3"></i>Quản trị phiếu hoàn trả</h2>
        <div class="dashboard-subtitle">
            <i class="fas fa-chart-line me-2"></i>
            Quản lý và xử lý các yêu cầu hoàn trả từ khách hàng
            @if (hoaDonId != Guid.Empty)
            {
                <span class="ms-3">| Hóa đơn: <strong>@hoaDonId</strong></span>
            }
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="totalCount">@Model?.Count() ?? 0</div>
                <div class="stat-label">Tổng phiếu hoàn trả</div>
                <i class="fas fa-clipboard-list stat-icon"></i>
            </div>
            <div class="stat-card pending">
                <div class="stat-number" id="pendingCount">@Model?.Count(x => x.TrangThai == 0) ?? 0</div>
                <div class="stat-label">Chờ xử lý</div>
                <i class="fas fa-clock stat-icon"></i>
            </div>
            <div class="stat-card approved">
                <div class="stat-number" id="approvedCount">@Model?.Count(x => x.TrangThai == 1) ?? 0</div>
                <div class="stat-label">Đã duyệt</div>
                <i class="fas fa-check-circle stat-icon"></i>
            </div>
            <div class="stat-card rejected">
                <div class="stat-number" id="rejectedCount">@Model?.Count(x => x.TrangThai == 2) ?? 0</div>
                <div class="stat-label">Từ chối</div>
                <i class="fas fa-times-circle stat-icon"></i>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-grid">
            <div class="search-filters">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm sản phẩm, lý do, mã phiếu..." />
                </div>
                <div class="filter-group">
                    <select id="statusFilter" class="form-select filter-select">
                <option value="">Tất cả trạng thái</option>
                <option value="0">Chờ xử lý</option>
                <option value="1">Đã duyệt</option>
                <option value="2">Từ chối</option>
            </select>
                    <input type="date" id="dateFrom" class="form-control filter-date" placeholder="Từ ngày" />
                    <input type="date" id="dateTo" class="form-control filter-date" placeholder="Đến ngày" />
                    <button class="btn btn-filter" onclick="applyFilters()">
                        <i class="fas fa-filter me-2"></i>Lọc
                    </button>
                </div>
            </div>
            <div class="toolbar-actions">
                <button class="btn btn-outline-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i>Tải lại
                </button>
                <button class="btn btn-primary" onclick="exportData()">
                    <i class="fas fa-download me-2"></i>Xuất Excel
                </button>
        </div>
        </div>
    </div>

    <!-- Table -->
    <div class="table-section">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="table-container">
        <div class="table-responsive">
                <table class="table table-hover" id="returnsTable">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th class="text-center">Số lượng</th>
                            <th>Ngày yêu cầu</th>
                        <th>Lý do</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model == null || !Model.Any())
                    {
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-inbox"></i>
                                        </div>
                                        <h5>Chưa có phiếu hoàn trả nào</h5>
                                        <p class="text-muted">Khi có yêu cầu hoàn trả từ khách hàng, chúng sẽ xuất hiện ở đây.</p>
                                    </div>
                                </td>
                            </tr>
                    }
                    else
                    {
                        foreach (var item in Model)
                        {
                            var ngay = item.NgayHoanTra == default ? "" : item.NgayHoanTra.ToString("yyyy-MM-dd");
                                <tr data-status="@item.TrangThai" data-date="@ngay" data-search="@item.TenSanPham.ToLower() @item.LyDoHoanTra.ToLower() @item.PhieuHoanTraId.ToString().ToLower()">
                                    <td>
                                        <div class="product-info">
                                            <div class="product-image">
                                                @if (!string.IsNullOrEmpty(item.AnhSanPham))
                                                {
                                                    <img src="@item.AnhSanPham" alt="@item.TenSanPham" />
                                                }
                                                else
                                                {
                                                    <i class="fas fa-box text-muted"></i>
                                                }
                                            </div>
                                            <div class="product-details">
                                                <h6>@item.TenSanPham</h6>
                                                <small>Mã: @item.PhieuHoanTraId.ToString().Substring(0, 8)...</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary rounded-pill">@item.SoLuongHoan</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(ngay))
                                        {
                                            <span class="text-muted">@DateTime.Parse(ngay).ToString("dd/MM/yyyy")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="@item.LyDoHoanTra">
                                            @item.LyDoHoanTra
                                        </div>
                                </td>
                                    <td class="text-center">
                                    @switch (item.TrangThai)
                                    {
                                        case 0:
                                                <span class="status-badge status-pending">Chờ xử lý</span>
                                            break;
                                        case 1:
                                                <span class="status-badge status-approved">Đã duyệt</span>
                                            break;
                                        case 2:
                                                <span class="status-badge status-rejected">Từ chối</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">Không xác định</span>
                                            break;
                                    }
                                </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a class="btn btn-action btn-view" asp-action="Details" asp-route-id="@item.PhieuHoanTraId" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </a>

                                    @if (item.TrangThai != 1)
                                    {
                                                <button type="button" class="btn btn-action btn-approve toggle-status-btn"
                                                data-id="@item.PhieuHoanTraId" 
                                                data-controller="PhieuHoanTraAdmin"
                                                data-area="Admin"
                                                data-current-status="@(item.TrangThai == 1 ? "true" : "false")"
                                                title="Duyệt phiếu">
                                                    <i class="fas fa-check"></i>
                                        </button>
                                    }

                                    @if (item.TrangThai != 2)
                                    {
                                        <form asp-action="UpdateTrangThai" method="post" class="d-inline"
                                                      onsubmit="return confirm('Bạn có chắc muốn từ chối phiếu này?');">
                                            <input type="hidden" name="id" value="@item.PhieuHoanTraId" />
                                            <input type="hidden" name="trangThai" value="2" />
                                            <input type="hidden" name="hoaDonId" value="@hoaDonId" />
                                                    <button class="btn btn-action btn-reject" type="submit" title="Từ chối">
                                                        <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    }

                                    <form asp-action="Delete" method="post" class="d-inline"
                                                  onsubmit="return confirm('Bạn có chắc muốn xóa phiếu này?');">
                                        <input type="hidden" name="id" value="@item.PhieuHoanTraId" />
                                        <input type="hidden" name="hoaDonId" value="@hoaDonId" />
                                                <button class="btn btn-action btn-delete" type="submit" title="Xóa">
                                                    <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                        </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin-toggle-status.js"></script>
    <script>
        // Filter functionality
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            document.querySelectorAll('#returnsTable tbody tr').forEach(tr => {
                const searchData = tr.getAttribute('data-search') || '';
                const status = tr.getAttribute('data-status');
                const date = tr.getAttribute('data-date') || '';

                const matchesSearch = !searchTerm || searchData.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesDateFrom = !dateFrom || (date && date >= dateFrom);
                const matchesDateTo = !dateTo || (date && date <= dateTo);

                tr.style.display = (matchesSearch && matchesStatus && matchesDateFrom && matchesDateTo) ? '' : 'none';
            });

            updateStatistics();
        }

        // Update statistics based on visible rows
        function updateStatistics() {
            const visibleRows = document.querySelectorAll('#returnsTable tbody tr:not([style*="display: none"])');
            const total = visibleRows.length;
            const pending = Array.from(visibleRows).filter(row => row.getAttribute('data-status') === '0').length;
            const approved = Array.from(visibleRows).filter(row => row.getAttribute('data-status') === '1').length;
            const rejected = Array.from(visibleRows).filter(row => row.getAttribute('data-status') === '2').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('rejectedCount').textContent = rejected;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            applyFilters();
        });

        // Status filter
        document.getElementById('statusFilter').addEventListener('change', function() {
            applyFilters();
        });

        // Date filters
        document.getElementById('dateFrom').addEventListener('change', function() {
            applyFilters();
        });

        document.getElementById('dateTo').addEventListener('change', function() {
            applyFilters();
        });

        // Refresh data
        function refreshData() {
            location.reload();
        }

        // Export data
        function exportData() {
            const visibleRows = document.querySelectorAll('#returnsTable tbody tr:not([style*="display: none"])');
            if (visibleRows.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Sản phẩm,Số lượng,Ngày yêu cầu,Lý do,Trạng thái\n";

            visibleRows.forEach(row => {
                const productName = row.querySelector('.product-details h6').textContent;
                const quantity = row.querySelector('.badge').textContent;
                const date = row.querySelector('td:nth-child(3)').textContent.trim();
                const reason = row.querySelector('td:nth-child(4)').textContent.trim();
                const status = row.querySelector('.status-badge').textContent;

                csvContent += `"${productName}","${quantity}","${date}","${reason}","${status}"\n`;
            });

            // Download file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "phieu_hoan_tra.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Auto-refresh every 30 seconds
        setInterval(function() {
            // Only refresh if no filters are applied
            const hasFilters = document.getElementById('searchInput').value || 
                              document.getElementById('statusFilter').value || 
                              document.getElementById('dateFrom').value || 
                              document.getElementById('dateTo').value;
            
            if (!hasFilters) {
                refreshData();
            }
        }, 30000);

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize any tooltips if using Bootstrap
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });
    </script>
}
