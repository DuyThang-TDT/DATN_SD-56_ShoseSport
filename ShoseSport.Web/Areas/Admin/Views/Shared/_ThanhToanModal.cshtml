@model dynamic
@{
    // Ép kiểu an toàn danh sách hình thức thanh toán
    var hinhThucThanhToanList = (Model.HinhThucThanhToanList as IEnumerable<FurryFriends.API.Models.DTO.BanHang.HinhThucThanhToanDto>)
                                ?? new List<FurryFriends.API.Models.DTO.BanHang.HinhThucThanhToanDto>();
}

<div class="modal fade" id="thanhToanModal" tabindex="-1" aria-labelledby="thanhToanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- Dùng thẻ form để validation nhưng sẽ submit bằng JS -->
            <form id="paymentForm" novalidate>
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="thanhToanModalLabel"><i class="fas fa-wallet me-2"></i>Xác nhận Thanh toán</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <p class="text-muted mb-1">TỔNG TIỀN CẦN THANH TOÁN</p>
                        <h2 id="thanhToanTongTien" class="fw-bold text-success">0 ₫</h2>
                    </div>

                    <!-- Hình thức thanh toán -->
                    <div class="mb-3">
                        <label for="hinhThucThanhToanSelect" class="form-label">Hình thức thanh toán <span class="text-danger">*</span></label>
                        <select id="hinhThucThanhToanSelect" class="form-select" required>
                            @if (hinhThucThanhToanList.Any())
                            {
                                @foreach (var httt in hinhThucThanhToanList)
                                {
                                    // SỬA ĐỔI QUAN TRỌNG:
                                    // Dùng LoaiHinhThuc (nếu có) hoặc tên để xác định data-type
                                    // Điều này giúp logic JS ổn định hơn, không phụ thuộc vào chuỗi text
                                    var dataType = httt.LoaiHinhThuc == 1 ? "cash" : "other";
                                    <option value="@httt.HinhThucThanhToanId" data-type="@dataType">@httt.TenHinhThuc</option>
                                }
                            }
                            else
                            {
                                <option value="">Không có hình thức thanh toán</option>
                            }
                        </select>
                        <div class="invalid-feedback">Vui lòng chọn hình thức thanh toán.</div>
                    </div>

                    <!-- Ghi chú -->
                    <div class="mb-3">
                        <label for="ghiChuThanhToan" class="form-label">Ghi chú thanh toán</label>
                        <textarea id="ghiChuThanhToan" class="form-control" rows="2"></textarea>
                    </div>



                    <!-- Nút hiển thị mã VietQR (sẽ được điều khiển bằng JS) -->
                    <div class="text-center" id="vietQRButtonContainer" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" id="showVietQRBtn">
                            <i class="fas fa-qrcode me-1"></i> Hiển thị mã VietQR
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success" id="confirmPaymentBtn">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Xác nhận Thanh toán
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript dành riêng cho Modal này -->
<script>
    $(document).ready(function() {
        const paymentModal = $('#thanhToanModal');
        const hinhThucSelect = $('#hinhThucThanhToanSelect');
        const vietQRButtonContainer = $('#vietQRButtonContainer');
        const paymentForm = $('#paymentForm');

        hinhThucSelect.on('change', function() {
            const selectedType = $(this).find('option:selected').data('type');
            const selectedText = $(this).find('option:selected').text().toLowerCase();
            const isCash = selectedType === 'cash';
            // Kiểm tra nhiều cách viết khác nhau của "chuyển khoản"
            const isBankTransfer = selectedText.includes('chuyển khoản') || 
                                  selectedText.includes('bank transfer') || 
                                  selectedText.includes('chuyển khoản') ||
                                  selectedText.includes('bank') ||
                                  selectedText.includes('transfer');

            console.log('Payment method changed:'); // Debug log
            console.log('- Selected type:', selectedType); // Debug log
            console.log('- Selected text:', selectedText); // Debug log
            console.log('- Is cash:', isCash); // Debug log
            console.log('- Is bank transfer:', isBankTransfer); // Debug log

            // Chỉ hiện nút VietQR khi chọn chuyển khoản
            vietQRButtonContainer.toggle(isBankTransfer);
            
            console.log('VietQR button container visibility:', vietQRButtonContainer.is(':visible')); // Debug log
        });



        paymentModal.on('show.bs.modal', function() {
            paymentForm[0].reset();
            paymentForm.removeClass('was-validated');
            
            // Debug: Log tất cả các option trong dropdown
            console.log('Available payment methods:');
            hinhThucSelect.find('option').each(function() {
                console.log('- Text:', $(this).text(), '| Type:', $(this).data('type'), '| Value:', $(this).val());
            });
            
            hinhThucSelect.trigger('change');
        });

        // Sự kiện submit sẽ được lắng nghe bởi View chính (TaoHoaDonMoi.cshtml)
        // để thực hiện gọi API.
        
        // Event handler cho nút VietQR
        $(document).on('click', '#showVietQRBtn', function() {
            // Gọi function showQRCode từ parent view
            if (typeof showQRCode === 'function') {
                showQRCode();
            } else {
                console.error('showQRCode function not found');
            }
        });
        
        // Event handler cho nút Transfer Success
        $(document).on('click', '#btnTransferSuccess', function() {
            if (typeof confirmTransferSuccess === 'function') {
                confirmTransferSuccess();
            } else {
                console.error('confirmTransferSuccess function not found');
            }
        });
        // Ngăn form submit mặc định
        paymentForm.on('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        });
        
        // Thêm event handler cho button submit để xử lý logic thanh toán
        $(document).on('click', '#confirmPaymentBtn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Confirm payment button clicked'); // Debug log
            
            // Validate form
            if (!paymentForm[0].checkValidity()) {
                paymentForm.addClass('was-validated');
                return false;
            }
            
            // Kiểm tra nếu là chuyển khoản thì chỉ hiển thị thông báo
            const selectedText = hinhThucSelect.find('option:selected').text().toLowerCase();
            const isBankTransfer = selectedText.includes('chuyển khoản') || selectedText.includes('bank transfer');
            
            console.log('Selected payment method:', selectedText); // Debug log
            console.log('Is bank transfer:', isBankTransfer); // Debug log
            
            if (isBankTransfer) {
                // Đóng modal thanh toán và mở QR code trực tiếp
                paymentModal.modal('hide');
                
                // Mở QR code modal sau khi đóng modal thanh toán
                setTimeout(() => {
                    if (typeof showQRCode === 'function') {
                        showQRCode();
                    } else {
                        console.error('showQRCode function not found');
                    }
                }, 300); // Delay để modal thanh toán đóng hoàn toàn
            } else {
                // Với các hình thức khác, để parent view xử lý
                // Trigger custom event để parent view biết
                console.log('Triggering paymentFormSubmitted event'); // Debug log
                $(document).trigger('paymentFormSubmitted', {
                    formData: {
                        hinhThucThanhToan: hinhThucSelect.find('option:selected').text(),
                        tienKhachDua: tienKhachDuaInput.val(),
                        ghiChu: $('#ghiChuThanhToan').val()
                    }
                });
            }
            
            return false;
        });
    });
</script>